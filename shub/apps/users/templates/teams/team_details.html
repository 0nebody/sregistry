{% extends "base/base.html" %}
{% load staticfiles %}

{% block css %}
<link rel="stylesheet" href="{% static "css/material-table.css"%}">
{% endblock %}
{% block content %}
{% include 'messages/message.html' %}

<div class="row" style="display:none" id="messages">
    {% if edit_permission %}{% if code %}
    <div class="col-md-12">
        <p id="message" class="alert alert-info">You have generated an invite code! Copy this in a safe place, it will only be available once.        
        </p>
    </div>
    {% endif %}{% endif %}
    <div class="col-md-12">
        <p id="message" class="alert alert-info"></p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card card-block"  style='padding:20px'>

            <div class="row">
            <div class="col-md-12">
            {% if request.user not in team.get_members %}
                {% if team.permission == "invite" %}
                <button id="request_button"
                        type="button" 
                        class="btn btn-default btn-sm waves-effect waves-light">Request to Join</button>
                {% endif %}
                {% if team.permission == "open" %}
                <a href="{% url 'join_team' team.id %}">
                    <button type="button" 
                            class="btn btn-default btn-sm waves-effect waves-light">Join Team</button></a>
                {% endif %}
            {% else %}
                <a href="{% url 'leave_team' team.id %}">
                    <button type="button" class="btn btn-default btn-sm waves-effect waves-light">Leave Team</button>
                </a>
            {% endif %}

            {% if edit_permission %}
                <a href="{% url 'edit_team' team.id %}">
                   <button type="button" class="btn btn-sm btn-default waves-effect waves-light">Edit Team</button></a>
                <a href="{% url 'delete_team' team.id %}">
                   <button type="button" class="btn btn-sm btn-default waves-effect waves-light">Delete Team</button></a>
            {% endif %}
            {% if collaborate %}    
            <button onclick="TogetherJS(this); return false;" type="button" class="btn btn-default waves-effect waves-light">Go!</button>
            {% endif %}

            </div>
            </div>

     </div>
  </div>

    <div class="col-md-4">
        <div class="card card-block" >
           {% if team.team_image %}
           <img width="250px" src="{{ team.team_image.url }}" style="position:relative;top:-5px;border-radius:35px; padding-right:20px;margin-right:15px"/>
           {% else %}
           <img width="250px" src="{% static 'img/robot_package.png' %}" style="position:relative;top:-5px;border-radius:35px; padding-right:20px;margin-right:15px"/>
           {% endif %}
         <br><h4 style='text-align:center;color:666'>{{ team.name }}</h4>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-md-12">

    {% if count > 0 %}
      
        <div class="col-md-12" 
             class="table card material-table mdl-data-table--selectable">

        <h4 style="padding-top:30px">Team Members</h4>

        <table id="annotators" 
               class="table" 
               cellspacing="0" width="100%" style="padding-top:20px"> 
           <thead>
               <tr>
                   <th>Name</th>
                   <th>Roles</th>
                   {% if edit_permission %}
                   <th></th>
                   {% endif %}
               </tr>
           </thead>
           <tbody>
            {% for member in members %}
               <tr id="member_row_{{ member.id }}">
                   <td>{{ member.username }}</td>
                   <td>{% if member in team.members.all %}
                       <span class="label label-info">member</span>
                       {% endif %}
                       {% if member in team.owners.all %}
                       <span class="label label-primary">owner</span>
                       {% endif %}
                   </td>
                   {% if edit_permission %}

                   <td>
                       <!-- Membership -->                  
                       {% if member in team.members.all %}
                       {% if request.user == member %}
                       <button class="btn btn-danger btn-xs leave_team" 
                               id="userid_{{ member.id }}">Leave Team</button>
                       {% else %}
                       <button class="btn btn-danger btn-xs remove_member" 
                               id="userid_{{ member.id }}">Remove Member</button>
                       {% endif %}
                       {% endif %}

                       <!-- Ownership -->                  
                       {% if member in team.owners.all %} 
                       {% if team.owners.count > 1 %}
                       <button class="btn btn-danger btn-xs remove_owner" 
                               id="userid_{{ member.id }}">Remove Owner</button>
                       {% else %}
                       <button class="btn btn-danger btn-xs remove_owner"
                               title="A team must have at least one owner." 
                               id="userid_{{ member.id }}" disabled>Remove Owner</button>
                       {% endif %} 

                       {% else %}
                       <button class="btn btn-danger btn-xs make_owner" 
                               id="userid_{{ member.id }}">Make Owner</button>
                       {% endif %}
                   </td>
               {% endif %}
               </tr>
            {% endfor %}
           </tbody>
       </table>
</div>
{% else %}

<!--STOPPED HERE... add collections function to teams-->

     <p>There are no members in this team!</p>

{% endif %}

{% endblock %}
{% block scripts %}
<script src="{% static "js/cookie-token.js" %}"></script>
<script src="{% static "js/jquery.dataTables.min.js"%}"></script>
<script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
<script src="{% static "js/materialize.min.js"%}"></script>
<script src="{% static "js/material.datatables.js"%}"></script>

<style>
.mdl-grid {
   padding-bottom:20px !important;
}
</style>
<script>
$(document).ready(function(){

    $('#annotators').DataTable( {
        columnDefs: [
            {
                targets: [ 0, 1 ],
                className: 'mdl-data-table__cell--non-numeric'
            }
        ]
    } );

    $('.material-pagination').hide();
    $(".browser-default").change(function(){
        $('.material-pagination').hide();
    })

   {% if edit_permission %}

   function removeMember(user_id, membership, action) {

        $.ajax({
            url : "/teams/{{ team.id }}/" + action+ "/" + membership + "/" + user_id,
            type : "POST", 

            success : function(json) {
                console.log(json);
                $("#message").text(json['message'])
                $("#messages").show();
                $("#member_row_" + user_id).remove();
            },

            error : function(xhr,errmsg,err) {
                console.log(xhr.status + ": " + xhr.responseText);
            }
         });
    }
   {% endif %}

   // Flag a small or bad image
   function requestInvite() {

        $.ajax({
            url : "{% url 'request_membership' team.id %}", // the endpoint
            type : "POST", // http method

            // handle a successful response
            success : function(json) {
                console.log(json); // log the returned json to the console
                $("#message").text(json['message'])
                $("#messages").show();
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                console.log(xhr.status + ": " + xhr.responseText); 
            }
         });
    }

   $("#request_button").click(function(){
      setTimeout(function(){
           requestInvite();
      },500)
   })

   {% if edit_permission %}

   $(".remove_owner").click(function(){
      var user_id = $(this).attr("id").replace("userid_","")
      setTimeout(function(){
           removeMember(user_id, 'owner', 'remove');
      },500)
   })

   $(".add_owner").click(function(){
      var user_id = $(this).attr("id").replace("userid_","")
      setTimeout(function(){
           removeMember(user_id, 'owner', 'add');
      },500)
   })


   $(".remove_member").click(function(){
      var user_id = $(this).attr("id").replace("userid_","")
      setTimeout(function(){
           removeMember(user_id, 'member', 'remove');
      },500)
   })

   {% endif %}


})
</script>
{% endblock %}
